---
- name: Configure Ubuntu for QEMU Guest Agent, Docker, and Folder Permissions
  hosts: new_hosts
  become: true
  tasks:
    - name: Resolve interrupted dpkg processes
      command: dpkg --configure -a
      become: true

    - name: Install and enable QEMU Guest Agent
      apt:
        name: qemu-guest-agent
        state: present
      notify:
        - Enable QEMU Guest Agent

    - name: Enable QEMU Guest Agent
      systemd:
        name: qemu-guest-agent.service
        enabled: true
        state: started

    - name: install dependencies
      apt:
        name: 
          - ca-certificates 
          - curl 
          - gnupg 
          - lsb-release
        state: present
        update_cache: true

    - name: add GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: add docker repository to apt
      apt_repository:
        filename: docker 
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu jammy stable
        state: present

    - name: install docker engine
      apt:
        name: 
          - docker-ce 
          - docker-ce-cli 
          - containerd.io
        state: present
        update_cache: true

    - name: test docker
      command: docker info
      become: true

    - name: Create folder /home/jmonaco/persistent
      file:
        path: /home/jmonaco/persistent
        state: directory
        owner: jmonaco
        group: jmonaco
        mode: '0755'

  handlers:
    - name: Enable QEMU Guest Agent
      systemd:
        name: qemu-guest-agent.service
        state: restarted
        enabled: true
